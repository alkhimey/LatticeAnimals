require "socket"
#$IP_ADDRESS="132.69.230.89"
$IP_ADDRESS="132.68.39.158"
$PORT=20000

def parameters_to_filename(d,n,breakpoint, total_chunks,current_chunk)
	"results/ProperPolyominoCount-#{d}d-#{n}n-breakAt#{breakpoint}-#{current_chunk}of#{total_chunks}.txt"
end
def parameters_to_commandline(d,n,breakpoint, total_chunks,current_chunk)
	"./PolyominoCounter #{d} #{n} #{breakpoint} #{total_chunks} #{current_chunk}"
end

while(true)
	#connecting to receive assignemnt
	socket=TCPSocket.new($IP_ADDRESS, $PORT)
	socket.write("receiving new assignment\n")
	assignment=socket.recv(100)
	socket.close
	if (assignment=="No assignment, but thanks\n")
		puts "The computation is complete, thanks for your help!\n"
		exit
	end
	#do assignment
	d,n,breakpoint,current_chunk,total_chunks=assignment.split(":")
	commandline=parameters_to_commandline(d,n,breakpoint,total_chunks,current_chunk)
	filename=parameters_to_filename(d,n,breakpoint,total_chunks,current_chunk)
	puts commandline
	`#{commandline}`
	results = File.open(filename,"r") { |file| file.read}
	puts results
	
	#connecting to send info
	socket=TCPSocket.new($IP_ADDRESS, $PORT)
	socket.write("sending info\n")
	message=socket.recv(100)
	if (message=="Bring it on\n")
		socket.write("#{current_chunk}:::#{filename}:::#{results}")
	end
	socket.close
end